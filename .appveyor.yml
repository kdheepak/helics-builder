version: '{build}'

branches:
  only:
  - master

image:
- Visual Studio 2017

configuration:
- Release

environment:
  matrix:
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      platform: x32
      GENERATOR: Visual Studio 15 2017

    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      platform: x64
      GENERATOR: Visual Studio 15 2017 Win64

matrix:
  fast_finish: true

# skip unsupported combinations
init:
  - echo %APPVEYOR_BUILD_WORKER_IMAGE%
  - echo %GENERATOR%

install:
  - mkdir C:\ninja
  - appveyor DownloadFile https://github.com/ninja-build/ninja/releases/download/v1.9.0/ninja-win.zip -FileName ninja.zip
  - 7z x ninja.zip -oC:\ninja > nul
  - set PATH=C:\ninja;%PATH%

before_build:
  - call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64
  - cmd: |-
      git clone --branch v2.1.1 https://github.com/GMLC-TDC/HELICS
      cd HELICS
      mkdir build
      cd build
      cmake --version
      cmake .. -G "%GENERATOR%" -DBOOST_ROOT=C:\Libraries\boost_1_67_0 -DENABLE_PACKAGE_BUILD=ON -DBUILD_RELEASE_ONLY=ON -DBUILD_C_SHARED_LIB=ON -DBUILD_SHARED_LIBS=ON
      cmake --build . --config Release --target install

build:
  project: HELICS/build/HELICS.sln
  parallel: true
  verbosity: minimal

after_build:
  - cd HELICS/build
  - cpack -B %cd%/installer-output

artifacts:
  - path: build/installer-output/Helics-*.exe

